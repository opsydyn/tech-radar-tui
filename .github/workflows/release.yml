name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build-release:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact: tech-radar-tui-linux
            bin: ratatui_adr-gen
          - os: macos-latest
            artifact: tech-radar-tui-macos
            bin: ratatui_adr-gen
          - os: windows-latest
            artifact: tech-radar-tui-windows.exe
            bin: ratatui_adr-gen.exe

    defaults:
      run:
        working-directory: ${{ github.workspace }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Moon
        if: matrix.os != 'windows-latest'
        run: |
          curl -fsSL https://moonrepo.dev/install.sh | bash -s -- --yes
          echo "$HOME/.moon/bin" >> "$GITHUB_PATH"
          "$HOME/.moon/bin/moon" --version

      - name: Install Moon (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          Invoke-WebRequest https://moonrepo.dev/install.ps1 -OutFile install-moon.ps1
          ./install-moon.ps1 -yes
          "$env:USERPROFILE\.moon\bin" | Out-File -FilePath $env:GITHUB_PATH -Append
          & "$env:USERPROFILE\.moon\bin\moon.exe" --version

      - name: Moon check
        if: matrix.os == 'ubuntu-latest'
        run: $HOME/.moon/bin/moon run tui:check

      - name: Moon test
        if: matrix.os == 'ubuntu-latest'
        run: $HOME/.moon/bin/moon run tui:test

      - name: Build release
        if: matrix.os != 'windows-latest'
        run: $HOME/.moon/bin/moon run tui:build

      - name: Build release (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          $env:USERPROFILE\.moon\bin\moon.exe run tui:build

      - name: Prepare artifact (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          mkdir -p dist
          cp "apps/tui/target/release/${{ matrix.bin }}" "dist/${{ matrix.artifact }}"

      - name: Prepare artifact (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          New-Item -ItemType Directory -Path dist -Force | Out-Null
          Copy-Item "apps/tui/target/release/${{ matrix.bin }}" "dist/${{ matrix.artifact }}"

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/${{ matrix.artifact }}
